@using TheradexPortal.Data.Models
@using TheradexPortal.Data
@using TheradexPortal.Data.Services
@using Newtonsoft.Json
@using Microsoft.JSInterop;
@using TheradexPortal.Data.Services.Abstract;
@using TheradexPortal.Data.Static;
@inject IHttpContextAccessor httpContextAccessor
@inject IConfiguration configuration

<Modal @ref="overviewModal" >
    <ModalContent Size="ModalSize.ExtraLarge">
        <ModalHeader Background="Background.Primary">
            <ModalTitle TextColor="TextColor.White">Overview</ModalTitle>
            <CloseButton TextColor="TextColor.White" />
        </ModalHeader>
        <ModalBody Class="overview-Modal-Body">
            <Table Hoverable>
                <TableBody>
                    <TableRow>
                        <TableRowHeader Background="Background.Light" Class="overview-Row-Header">Study ID</TableRowHeader>
                        @foreach (var study in SelectedStudies)
                        {
                            <TableRowCell>@(study.StudyId)</TableRowCell>
                        }
                    </TableRow>
                    <TableRow>
                        <TableRowHeader Background="Background.Light" Class="overview-Row-Header">Title</TableRowHeader>
                        @foreach (var study in SelectedStudies)
                        {
                            <TableRowCell>@(study.ProtocolTitle)</TableRowCell>
                        }
                    </TableRow>
                    <TableRow>
                        <TableRowHeader Background="Background.Light" Class="overview-Row-Header">Primary Investigator</TableRowHeader>
                        @foreach (var study in SelectedStudies)
                        {
                            <TableRowCell>@(study.Investigator)</TableRowCell>
                        }
                    </TableRow>
                    <TableRow>
                        <TableRowHeader Background="Background.Light" Class="overview-Row-Header">Monitoring Method</TableRowHeader>
                        @foreach (var study in SelectedStudies)
                        {
                            <TableRowCell>@(study.MonitoringMethod)</TableRowCell>
                        }
                    </TableRow>
                    <TableRow>
                        <TableRowHeader Background="Background.Light" Class="overview-Row-Header">Accrual (Screening/Intervention/Other)</TableRowHeader>
                        @foreach (var study in SelectedStudies)
                        {
                            <TableRowCell>@(TotalField(study.TotalScreeningCount, study.TotalInterventionCount, study.TotalOtherCount))</TableRowCell>
                        }
                    </TableRow>
                    <TableRow>
                        <TableRowHeader Background="Background.Light" Class="overview-Row-Header">Date of Last EDC Update</TableRowHeader>
                        @foreach (var study in SelectedStudies)
                        {
                            <TableRowCell>
                                @{
                                    if (study.DateOfEDCUpdate != null)
                                    {
                                        @(study.DateOfEDCUpdate.Value.ToString("dd-MMM-yyyy"))
                                    }
                                }
                            </TableRowCell>
                        }
                    </TableRow>
                    <TableRow>
                        <TableRowHeader Background="Background.Light" Class="overview-Row-Header">Total Patients In ODH</TableRowHeader>
                        @foreach (var study in SelectedStudies)
                        {
                            <TableRowCell>@(study.PatientsEnrolled)</TableRowCell>
                        }
                    </TableRow>
                    <TableRow>
                        <TableRowHeader Background="Background.Light" Class="overview-Row-Header">Total Patients Treated In ODH</TableRowHeader>
                        @foreach (var study in SelectedStudies)
                        {
                            <TableRowCell>@(study.PatientTreated)</TableRowCell>
                        }
                    </TableRow>
                    <TableRow>
                        <TableRowHeader Background="Background.Light" Class="overview-Row-Header">Recent Enrollment In ODH</TableRowHeader>
                        @foreach (var study in SelectedStudies)
                        {
                            <TableRowCell>
                                @{
                                    if (study.DateOfLastRegistration != null)
                                    {
                                        @(study.DateOfLastRegistration.Value.ToString("dd-MMM-yyyy"))
                                    }
                                }
                            </TableRowCell>
                        }
                    </TableRow>
                    <TableRow>
                        <TableRowHeader Background="Background.Light" Class="overview-Row-Header">Subsequent Phase Activation Date</TableRowHeader>
                        @foreach (var study in SelectedStudies)
                        {
                            <TableRowCell>
                                @{
                                    if (study.PhaseActivationDate != null)
                                    {
                                        @(study.PhaseActivationDate.Value.ToString("dd-MMM-yyyy"))
                                    }
                                }
                            </TableRowCell>
                        }
                    </TableRow>
                </TableBody>
            </Table>
        </ModalBody>
        <ModalFooter></ModalFooter>
    </ModalContent>
</Modal>

@code {
    [Parameter] public List<Protocol> SelectedStudies { get; set; } = new List<Protocol>();
    private Modal? overviewModal;

    public void ShowStudy(Protocol study)
    {
        SelectedStudies.Clear();
        SelectedStudies.Add(study);
        showModal();
    }

    public void ShowStudies(List<Protocol> studies)
    {
        SelectedStudies = studies;
        showModal();
    }

    private void showModal()
    {
        StateHasChanged();
        overviewModal!.Show();
    }

    private string TotalField(string screening, string intervention, string other)
    {
        return screening + "/" + intervention + "/" + other;
    }
}
