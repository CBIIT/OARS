@using TheradexPortal.Data.Models;
@using TheradexPortal.Data.Services;
@using TheradexPortal.Data;
@using TheradexPortal.Data.Services.Abstract;

<BarItem @ref="@alertsItem" hidden="@alertsHidden">
    <BarDropdown RightAligned="@rightAligned" Visible="true">
        <BarDropdownToggle>
            <Image Source="img/alert-icon.png" height="@iconHeight" />
            Alerts
        </BarDropdownToggle>
        <BarDropdownMenu>
            @if (activeAlerts.Count > 0)
            {
                @foreach (var alert in activeAlerts)
                {
                    <BarDropdownItem>
                        <Alert Color="Color.Warning" Visible>
                            <AlertDescription TextOverflow="TextOverflow.Wrap">@alert.AlertText</AlertDescription>
                            <CloseButton />
                        </Alert>
                    </BarDropdownItem>
                }
            }
            else
            {
                <BarDropdownItem>No current alerts.</BarDropdownItem>
            }
        </BarDropdownMenu>
    </BarDropdown>
</BarItem>
<BarItem @ref="@notesItem" hidden="@notesHidden">
    <BarDropdown RightAligned="@rightAligned">
        <BarDropdownToggle>
            <Image Source="img/notification-icon.png" height="@iconHeight" />
            Notes
        </BarDropdownToggle>
        <BarDropdownMenu>
            @if (activeNotes.Count > 0)
            {
                @foreach (var note in activeNotes)
                {
                    <BarDropdownItem>
                        <Alert Color="Color.Info" Visible>
                            <AlertDescription TextOverflow="TextOverflow.Wrap">@note.AlertText</AlertDescription>
                            <CloseButton />
                        </Alert>
                    </BarDropdownItem>
                }
            }
            else
            {
                <BarDropdownItem>No current notes.</BarDropdownItem>
            }
        </BarDropdownMenu>
    </BarDropdown>
</BarItem>

@code {
    [Parameter] public bool LoginScreen { get; set; } = false;
    [Parameter] public bool System { get; set; } = false;
    [Parameter] public bool Dashboard { get; set; } = false;
    [Parameter] public Dashboard SelectedDashboard { get; set; } = null!;
    [Inject] private IAlertService alertService { get; set; } = null!;
    private int iconHeight = 24;
    private BarItem? alertsItem;
    private BarItem? notesItem;
    private bool rightAligned;
    private bool alertsHidden;
    private bool notesHidden;
    private IList<WRAlert> activeAlerts = new List<WRAlert>();
    private IList<WRAlert> activeNotes = new List<WRAlert>();

    protected override async Task OnInitializedAsync()
    {
        this.getSystemAlerts();
        this.getLoginAlerts();
        this.getDashboardAlerts();
        await base.OnInitializedAsync();
    }

    public void UpdateDashboard(Dashboard dashboard)
    {
        this.SelectedDashboard = dashboard;
        this.getDashboardAlerts();
    }

    private async void getSystemAlerts()
    {
        if (System)
        {
            this.rightAligned = true;
            this.activeAlerts = await alertService.GetActiveSystemAlertsAsync();
            this.activeNotes = await alertService.GetActiveSystemNotesAsync();
        }
    }

    private async void getLoginAlerts()
    {
        if (LoginScreen)
        {
            this.activeAlerts = await alertService.GetActiveLoginAlertsAsync();
            this.activeNotes = await alertService.GetActiveLoginNotesAsync();
        }
    }

    private async void getDashboardAlerts()
    {
        if (Dashboard)
        {
            this.notesHidden = true;

            if (this.SelectedDashboard != null)
            {
                this.activeAlerts = await alertService.GetActiveDashboardAlertsByIdAsync(this.SelectedDashboard.WRDashboardId);
            }
        }
    }
}