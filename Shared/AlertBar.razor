@using TheradexPortal.Data.Models;
@using TheradexPortal.Data.Services;
@using TheradexPortal.Data;
@using TheradexPortal.Data.Services.Abstract;
@using TheradexPortal.Data.Static
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject ProtectedSessionStorage SessionData

@if (this.NoAlertsMessage && this.Alert)
{
    <Alert Color="infoColor" Visible="@this.defaultAlertVisible">
        <AlertDescription TextOverflow="TextOverflow.Wrap">No current alerts.</AlertDescription>
    </Alert>
}
@if (this.NoAlertsMessage && this.Note)
{
    <Alert Color="infoColor" Visible="@this.defaultAlertVisible">
        <AlertDescription TextOverflow="TextOverflow.Wrap">No current notes.</AlertDescription>
    </Alert>
}

@if (this.activeAlerts.Count > 0)
{
    if (this.alertsSessionLoaded)
    {
        foreach (var alert in activeAlerts)
        {
            if (!this.Dismissable || !this.alertDismissed(this.dismissedAlerts!, alert) && alertService.AlertDatesValid(alert.StartDate, alert.EndDate))
            {
                <Alert Color="currentColor" Visible Class="@CSS">
                    <AlertDescription TextOverflow="TextOverflow.Wrap">@((MarkupString)alert.AlertText!)</AlertDescription>
                    @if (this.Dismissable)
                    {
                        <CloseButton @onclick="() => dismissAlert(alert)" Class="nci-alert-closebutton" />
                    }
                </Alert>
            }
        }
    }
    else
    {
        <Alert Color="infoColor" Visible>
            <AlertDescription TextOverflow="TextOverflow.Wrap">Loading Alerts...</AlertDescription>
        </Alert>
    }
}
else
{
    this.defaultAlertVisible = true;
}

@code {
    [Parameter] public bool Alert { get; set; } = false;
    [Parameter] public bool Note { get; set; } = false;
    [Parameter] public bool LoginScreen { get; set; } = false;
    [Parameter] public bool System { get; set; } = false;
    [Parameter] public bool Dashboard { get; set; } = false;
    [Parameter] public bool Dismissable { get; set; } = false;
    [Parameter] public bool NoAlertsMessage { get; set; } = false;
    [Parameter] public string CSS { get; set; } = string.Empty;
    [Parameter] public EventCallback<int> AlertsCountChanged { get; set; }

    private bool alertsHidden;
    private bool notesHidden;
    private bool defaultAlertVisible;
    private bool alertsSessionLoaded;
    [Inject] private IAlertService alertService { get; set; } = null!;
    private BarItem? alertsItem;
    private BarItem? notesItem;
    private Color? currentColor;
    private Color? alertColor;
    private Color? noteColor;
    private Color? infoColor;
    private Dashboard selectedDashboard { get; set; } = null!;
    private IList<WRAlert> activeAlerts = new List<WRAlert>();
    private string? dismissedAlerts = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        this.getSystemAlerts();
        this.getLoginAlerts();
        this.getDashboardAlerts();
        await base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender) // required for performance. could add a timed bool check to refresh system alerts
        {
            await LoadSessionAlerts();
            this.alertColor = await alertService.AlertColor();
            this.noteColor = await alertService.NoteColor();
            this.infoColor = await alertService.InfoColor();
            this.currentColor = this.noteColor;
            this.setCurrentColor();
            this.alertsSessionLoaded = true;
            await this.updateAlertsCount(this.getActiveAlertsCount());
            StateHasChanged();
        }
    }

    public void UpdateDashboard(Dashboard dashboard)
    {
        this.selectedDashboard = dashboard;
        this.getDashboardAlerts();
        StateHasChanged();
    }

    private async void getSystemAlerts()
    {
        if (System)
        {
            if (Alert)
            {
                this.activeAlerts = await alertService.GetActiveSystemAlertsAsync();
            }
            if (Note)
            {
                this.activeAlerts = await alertService.GetActiveSystemNotesAsync();
            }
        }
    }

    private async void getLoginAlerts()
    {
        if (LoginScreen)
        {
            if (Alert)
            {
                this.activeAlerts = await alertService.GetActiveLoginAlertsAsync();
            }
            if (Note)
            {
                this.activeAlerts = await alertService.GetActiveLoginNotesAsync();
            }
        }
    }

    private async void getDashboardAlerts()
    {
        if (Dashboard)
        {
            if (Alert && this.selectedDashboard != null && this.selectedDashboard.WRDashboardId != 0)
            {
                this.activeAlerts = await alertService.GetActiveDashboardAlertsByIdAsync(this.selectedDashboard.WRDashboardId);
            }
            else 
            {
                this.activeAlerts = new List<WRAlert>();
            }
        }
    }

    private void setCurrentColor()
    {
        if (Alert)
        {
            this.currentColor = this.alertColor;
        }
        if (Note)
        {
            this.currentColor = this.noteColor;
        }
    }

    private bool alertDismissed(string dismissedAlerts, WRAlert alert)
    {
        return dismissedAlerts.Split('|').Any(x => x == alert.WRAlertId.ToString());
    }

    private int getActiveAlertsCount()
    {
        var alertsCount = 0;

        foreach (var activeAlert in this.activeAlerts)
        {
            if (!this.alertDismissed(this.dismissedAlerts!, activeAlert))
            {
                alertsCount++;
            }
        }

        return alertsCount;
    }

    private async Task dismissAlert(WRAlert alert)
    {
        var alertId = alert.WRAlertId.ToString();

        if (alert != null && !this.dismissedAlerts!.Contains(alertId))
        {
            if (this.dismissedAlerts.Length > 0)
            {
                this.dismissedAlerts += '|';
            }
            this.dismissedAlerts += alertId;
            await this.saveSessionAlerts(this.dismissedAlerts);

            var alertsCount = this.getActiveAlertsCount();

            if (alertsCount.Equals(0))
            {
                this.defaultAlertVisible = true;
            }

            await this.updateAlertsCount(alertsCount);
        }
    }

    private async Task LoadSessionAlerts()
    {
        var sessionDismissedAlerts = await SessionData.GetAsync<string>("dismissedAlerts");
        this.dismissedAlerts = sessionDismissedAlerts.Success ? sessionDismissedAlerts.Value : "";
    }

    private async Task saveSessionAlerts(string newData)
    {
        await SessionData.SetAsync("dismissedAlerts", newData);
    }

    private async Task updateAlertsCount(int alertsCount)
    {
        await this.AlertsCountChanged.InvokeAsync(alertsCount);
    }
}