@using System.Net.Http
@using System.Threading.Tasks
@using Microsoft.Extensions.Options;
@using TheradexPortal.Data
@using TheradexPortal.Data.Models;
@using TheradexPortal.Data.PowerBI
@using TheradexPortal.Data.PowerBI.Abstract;
@using TheradexPortal.Data.PowerBI.Models;
@using TheradexPortal.Data.Static;
@using TheradexPortal.Data.Services;
@using TheradexPortal.Data.Services.Abstract;
@inject IHttpContextAccessor httpContextAccessor;

<div @ref="@pbiElement" class="pbi-embed-container" />


@code {
    [Inject] private IJSRuntime js { get; set; } = null!;
    [Inject] private IOptions<PowerBI> powerBiConfig { get; set; } = null!;
    [Inject] private IPbiEmbedService pbiEmbedService { get; set; } = null!;
    [Inject] private IStudyService studyService { get; set; } = null!;
    [Inject] private IUserService userService { get; set; } = null!;
    [Inject] private IDashboardService dashboardService { get; set; } = null!;

    [Parameter] public Dashboard? Dashboard { get; set; }
    [Parameter] public Report? Report {get; set; }
    [CascadingParameter] LoadingIndicator loadingIndicator { get; set; } = null!;

    private ElementReference pbiElement;
    private IJSObjectReference? pbiEmbedModule;
    private IJSObjectReference? reportRef;
    private DotNetObjectReference<PowerBiFullReport>? objRef;
    private static Func<string, Task> UpdateFilterActionAsync;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        UpdateFilterActionAsync= LocalChangUpdateFilterValueAsync;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await loadingIndicator.Show();
        pbiEmbedModule = await js.InvokeAsync<IJSObjectReference>("import", "./js/powerbi-embed-fullreport.js");
        objRef = DotNetObjectReference.Create(this);
        await EmbedFullReportJS();
        await loadingIndicator.Hide();
    }

    public async Task Update()
    {
        if (reportRef != null)
        {
            await loadingIndicator.Show();
            await EmbedFullReportJS();
            await loadingIndicator.Hide();
        }
    }

    public async Task EmbedFullReportJS()
    {
        var userEmail = httpContextAccessor.HttpContext?.User?.FindFirst("preferred_username")?.Value;
        bool isAdmin = httpContextAccessor.HttpContext.User.HasClaim(WRClaimType.IsAdmin, "True");
        int userId = Convert.ToInt32(httpContextAccessor.HttpContext.User.FindFirst(WRClaimType.UserId).Value);
        var currentStudy = "";

        // Send in list of protocols - this is the list that will populate the STUDY_ID filter.
        string filteredStudies = studyService.GetSelectedStudyIdsForUser(userId);

        // This is the list that will start as checked in the STUDY_ID filter.
        string protocols = studyService.GetCurrentStudiesForUser(userId);

        //string filterURLString = "";
        if (protocols != null && protocols.Length > 0)
        {
            // Should only have one current study - but if there are more, only select the first.
            string[] studies = protocols.Split(',');
            currentStudy = studies[0];
        }

        if (string.IsNullOrEmpty(userEmail))
            throw new ArgumentNullException("Email address not found");

        EmbedParams embedParams;
        if (powerBiConfig.Value.UseRowLevelSecurity)
        {
            embedParams = pbiEmbedService.GetEmbedParams(new Guid(powerBiConfig.Value.WorkspaceId), new Guid(Report.PowerBIReportId), userEmail, powerBiConfig.Value.IdentityRoles);
        }
        else
        {
            embedParams = pbiEmbedService.GetEmbedParams(new Guid(powerBiConfig.Value.WorkspaceId), new Guid(Report.PowerBIReportId));
        }

        var embedUrl = embedParams.EmbedReport[0].EmbedUrl + "&pageName=" + Report.PowerBIPageName;
        
        
        //var visuals = await dashboardService.GetAllVisualsByReportIdAsync(Report.WRReportId);
        //Visual studySlicer = visuals.Where(v => v.VisualDescription == "STUDYID" && v.VisualType == "slicer").SingleOrDefault();
        //var slicerGuid = "";

        //if (studySlicer == null)
        //{
        //    currentStudy = "";
        //    slicerGuid = "";
        //}
        //else
        //{
        //    slicerGuid = studySlicer.PowerBIVisualId;
        //}

        //embedUrl += "&filter=PROTOCOL/STUDY_ID in ('10204')";
        //embedUrl += filterURLString;
        reportRef = await pbiEmbedModule.InvokeAsync<IJSObjectReference>(
            "embedFullReport",
            pbiElement,
            embedParams.EmbedToken.Token,
            WrConstants.PBI_STUDY_FILTER_TARGETS.ToArray(),
            embedUrl,
            embedParams.EmbedReport[0].ReportId.ToString(),
            (filteredStudies == null || filteredStudies == "") ? "" : filteredStudies.Split(','),
            currentStudy
        );
    }

    private async Task LocalChangUpdateFilterValueAsync(string value)
    {
        int userId = Convert.ToInt32(httpContextAccessor.HttpContext.User.FindFirst(WRClaimType.UserId).Value);
        
        //IList<Protocol> curStudies = studyService.GetCurrentStudiesForUser(userId);
        string curStudies = studyService.GetCurrentStudiesForUser(userId);

        bool saved = userService.SaveCurrentStudy(userId, value);

        //if (curStudies != value)
        //if ((curStudies == null && value != "") && curStudies != value)
        if (curStudies != value && !(curStudies == null && value == ""))
            saved = userService.SaveActivityLog(userId, WRActivityType.Study, "Select Study", value);
    }

    [JSInvokable]
    public static async Task SaveStudyFromSlicer(string study)
    {
        await UpdateFilterActionAsync.Invoke(study);
    }
}