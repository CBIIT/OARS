@page "/dashboard"
@layout SecondaryNavLayout

@using System.Net.Http
@using System.Threading.Tasks
@using TheradexPortal.Data;
@using TheradexPortal.Data.Models;
@using TheradexPortal.Data.PowerBI;
@using TheradexPortal.Data.ViewModels;


<LayoutSider>
    <SecondaryNav Actions="Actions" />
</LayoutSider>
<LayoutContent>
    <Container Fluid Class="mt-2">
        <PowerBiCustomLayout />
    </Container>
</LayoutContent>

<Modal @ref="modalRef">
    <ModalContent Centered Size="ModalSize.ExtraLarge">
        <ModalBody>
            <StudyGrid OnSave="@HideFilters"/>
        </ModalBody>
    </ModalContent>
</Modal>


@code {

    private Modal? modalRef;
    private PowerBiCustomLayout? customReportRef;
    private PowerBiFullReport? fullReportRef;
    private string selectedTab = "studies";

    private List<SecondaryNavAction> Actions => new List<SecondaryNavAction>
    {
        new SecondaryNavAction
        {
            IconName = IconName.Filter,
            Label = "Filters",
            OnClick = ShowFilters
        },
        new SecondaryNavAction
        {
            IconName = IconName.Random,
            Label = "Link",
            To = "/"
        }
    };

    private Task OnSelectedTabChanged( string name )
    {
        selectedTab = name;
        return Task.CompletedTask;
    }

    private async void ShowFilters()
    {
        if (modalRef != null)
        {
            await modalRef.Show();
        }
        
    }

    // hide modal
    private async void HideFilters(List<Protocol>? selectedStudies)
    {
        if (selectedTab == "tab1" && customReportRef != null)
        {
            await customReportRef.Update();
        }

        if (selectedTab == "tab2" &&fullReportRef != null)
        {
            await fullReportRef.Update();
        }

        if(modalRef != null)
        {
            await modalRef.Hide();
        }
    }
}