@attribute [Route(WrConstants.DASHBOARD_PAGE_PATH + "/{dashboardid:int}/{reportid:int?}")]
@layout SecondaryNavLayout
@inject IHttpContextAccessor httpContextAccessor

@using System.Net.Http
@using System.Threading.Tasks
@using TheradexPortal.Data;
@using TheradexPortal.Data.Models;
@using TheradexPortal.Data.PowerBI.Abstract;
@using TheradexPortal.Data.Services.Abstract;
@using TheradexPortal.Data.ViewModels;
@using TheradexPortal.Data.Static;

@if(notFound)
{
    <LayoutContent>
        <Container Fluid Class="mt-2 text-center">
            <NotFound />
        </Container>
    </LayoutContent>
}
else
{
    <PageTitle>@dashboard!.Name</PageTitle>
    <LayoutSider>
        <SecondaryNav Actions="Actions" Reports="allReports" />
    </LayoutSider>
    <LayoutContent>
        <Container Fluid Class="mt-2">
            @if(report != null && report.IsFullPage)
            {
                <PowerBiFullReport Dashboard="dashboard" Report="report" @ref="fullReportRef" />
            }
            else if(report != null)
            {
                <PowerBiCustomLayout Dashboard="dashboard" Report="report" @ref="customReportRef" />
            }
        </Container>
    </LayoutContent>
}

<Modal @ref="modalRef">
    <ModalContent Centered Size="ModalSize.ExtraLarge">
        <ModalBody>
            <StudyGrid OnSave="@HideFilters"/>
        </ModalBody>
    </ModalContent>
</Modal>


@code {
    [Inject] private IDashboardService dashboardService { get; set; } = null!;
    [Inject] private NavigationManager navigation {get; set; } = null!;

    [Parameter] public int DashboardId { get; set; }
    [Parameter] public int ReportId { get; set; }

    private bool notFound = false;
    private Modal? modalRef;
    private PowerBiCustomLayout? customReportRef;
    private PowerBiFullReport? fullReportRef;

    private TheradexPortal.Data.Models.Dashboard? dashboard;
    private IList<Report> allReports = new List<Report>();
    private Report? report;

    private IList<SecondaryNavAction> Actions => new List<SecondaryNavAction>
    {
        new SecondaryNavAction
        {
            IconName = IconName.Filter,
            Label = "Filters",
            OnClick = ShowFilters
        },

        new SecondaryNavAction
        {
            IconName = IconName.Receipt,
            Label = "Study Overview",
            OnClick = ShowOverview
        },

        new SecondaryNavAction
        {
            IconName = IconName.Bookmark,
            Label = "Recent Studies",
            OnClick = ShowOverview
        }
    };

    protected override async Task OnParametersSetAsync()
    {
        notFound = false;

        // Determine if user has access to requested dashboard & report
        string userDashboards = httpContextAccessor.HttpContext.User.FindFirst(WRClaimType.Dashboards).Value;
        string userReports = httpContextAccessor.HttpContext.User.FindFirst(WRClaimType.Reports).Value;

        dashboard = await dashboardService.GetDashboardByIdAsync(DashboardId, userDashboards);
        if(dashboard == null)
        {
            notFound = true;
            return;
        }

        bool isAdmin = httpContextAccessor.HttpContext.User.HasClaim(WRClaimType.Role, "Administrator");
        int userId = Convert.ToInt32(httpContextAccessor.HttpContext.User.FindFirst(WRClaimType.UserId).Value);

        allReports = await dashboardService.GetReportsByDashboardIdForUserAsync(DashboardId, userId, isAdmin);
        if (ReportId == 0)
        {
            report = allReports.FirstOrDefault();
            if(report == null)
            {
                notFound = true;
                return;
            }
            navigation.NavigateTo($"{WrConstants.DASHBOARD_PAGE_PATH}/{dashboard.WRDashboardId}/{report.WRReportId}", new NavigationOptions
            {
                ReplaceHistoryEntry = true
            });
        }
        else
        {
            report = allReports.FirstOrDefault(r => r.WRReportId == ReportId);
            if (report == null)
            {
                notFound = true;
                return;
            }
        }
    }

    // Show modal
    private async void ShowFilters()
    {
        if (modalRef != null)
        {
            await modalRef.Show();
        }
    }

    // Re-render report components and hide modal
    private async void HideFilters(List<Protocol>? selectedStudies)
    {
        if (report != null)
        {
            if (!report.IsFullPage && customReportRef != null)
            {
                await customReportRef.Update();
            }

            if (report.IsFullPage && fullReportRef != null)
            {
                await fullReportRef.Update();
            }
        }

        if(modalRef != null)
        {
            await modalRef.Hide();
        }
    }

    private async void ShowOverview()
    {
        if (modalRef != null)
        {
            await modalRef.Show();
        }
    }
}