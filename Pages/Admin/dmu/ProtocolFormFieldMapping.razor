@using TheradexPortal.Data.Models;
@using TheradexPortal.Data.Services.Abstract;
@inject IHttpContextAccessor httpContextAccessor
@inject IConfiguration configuration
@layout AdminLayout
@page "/admin/dmu/form-field-mapping/{protocolCategoryId:int}"
<AdminRoleCheck AllowedRoles="@(new List<string> { "IT" })"></AdminRoleCheck>
<Div Background="Background.Primary" TextColor="TextColor.Light" Class="p-1"><h2>DMU Mapping</h2></Div>
<Row Background="Background.Light" Style="padding-bottom:10px;">
    <Row>
        <Column>
            <Text><b>Protocol:</b> @protocol</Text>
        </Column>
        <Column>
            <Switch TValue="bool" Checked="@this.isComplete" CheckedChanged="@((v) => {this.isComplete = v; CompleteMapping();})">Mapping Complete</Switch>
        </Column>

    </Row>
    <Row>
        <Column>
            <Text><b>Report Category:</b> @currCategory.CategoryName</Text>
        </Column>
        <Column>
            <Switch TValue="bool" @bind-Checked="@isMultiForm">Multi Form</Switch>
        </Column>
    </Row>
</Row>
@if (!isMultiForm)
{
    <DataGrid @ref=dataGridRef
              TItem="ProtocolFieldMapping"
              Class="admindatagrid"
              Data="@protocolFieldMappingList"
              Editable
              Responsive
              Striped
              ShowPager
              ShowPageSizes
              MaxPaginationLinks="5"
              PagerPosition="DataGridPagerPosition.Bottom"
              PagerOptions="new(){ButtonSize=Size.Default,
                                PaginationPosition=PagerElementPosition.Default,
                                TotalItemsPosition=PagerElementPosition.End,
                                }"
              FixedHeader
              FixedHeaderDataGridHeight="calc(100vh - 240px)"
              FixedHeaderDataGridMaxHeight="calc(100vh - 240px)"
              EditMode="DataGridEditMode.Inline"
              RowUpdated="@Save"
              RowInserted="@Save"
              RowRemoved="@Delete"
              RowRemoving="@ConfirmDelete"
              SortMode="DataGridSortMode.Multiple">
        <DataGridColumns>
            <DataGridColumn Field="@nameof(ProtocolFieldMapping.ThorFieldId)" Width="25%" Caption="Select OARS Field" Editable="true" SortDirection="SortDirection.Ascending" Sortable>
                <DisplayTemplate>
                    <Text>@GetThorFieldLabel(context)</Text>
                </DisplayTemplate>
                <EditTemplate>
                    <Text>@GetThorFieldLabel(context.Item)</Text>
                  </EditTemplate>
            </DataGridColumn>
            <DataGridColumn Field="@nameof(ProtocolFieldMapping.ProtocolEDCFormId)" Width="25%" Caption="Select EDC Form" Filterable="true" Editable="true" SortDirection="SortDirection.Ascending" Sortable>
                <DisplayTemplate>
                    @{
                        if (context.ProtocolEDCFormId != null && context.ProtocolEDCFormId != 0)
                        {
                            var currForm = protocolEDCFormList.First(x => x.ProtocolEDCFormId == context.ProtocolEDCFormId);
                            <Text>@(currForm.EDCFormIdentifier + " - " + currForm.EDCFormName)</Text>
                        }
                        else if(context.ProtocolEDCFieldId != 0 && context.ProtocolEDCField != null && context.ProtocolEDCField.ProtocolEDCForm != null)
                        {
                            <Text>@(context.ProtocolEDCField.ProtocolEDCForm.EDCFormIdentifier + " - " + context.ProtocolEDCField.ProtocolEDCForm.EDCFormName)</Text>
                        } else
                        {
                            <Text>Not Mapped</Text>
                        }
                    }
                </DisplayTemplate>
                <EditTemplate>
                    <Autocomplete TItem="ProtocolEDCForm" Data="@protocolEDCFormList" TValue="int" TextField="@((item) => {return item.EDCFormIdentifier + " - " + item.EDCFormName;})" ValueField="@((item) => item.ProtocolEDCFormId)" SelectedValueChanged="@(e => {@GetFields(e); context.CellValue=e;})" SelectedValue="@(context.Item.ProtocolEDCFormId)" Placeholder="@(GetPlaceholder(context.Item))" Virtualize></Autocomplete>
                </EditTemplate>
            </DataGridColumn>
            <DataGridColumn Field="@nameof(ProtocolFieldMapping.ProtocolEDCFieldId)" Width="25%" Caption="Select EDC Field" Editable="true">
                <DisplayTemplate>
                    @{
                        if (context.ProtocolEDCFieldId != null && context.ProtocolEDCFieldId != 0 && context.ProtocolEDCField == null)
                        {
                            var currentField = protocolEDCFieldList.First(x => x.ProtocolEDCFieldId == context.ProtocolEDCFieldId);
                            <Text>@(currentField.EDCFieldIdentifier + " - " + currentField.EDCFieldName)</Text>
                        }
                        else if(context.ProtocolEDCField != null && context.ProtocolEDCField.ProtocolEDCFieldId != 0)
                        {
                            <Text>@context.ProtocolEDCField.EDCFieldIdentifier</Text>
                        } else
                        {
                            <Text>Not Mapped</Text>
                        }
                    }
                </DisplayTemplate>
                <EditTemplate>
                    <SelectList TItem="ProtocolEDCField" TValue="int" Data="@protocolEDCFieldList" TextField="@((item)=>item.EDCFieldIdentifier + " - " + item.EDCFieldName)"
                                ValueField="@((item) => item.ProtocolEDCFieldId)"
                                SelectedValueChanged="@( v =>{context.CellValue = v;})"
                                SelectedValue="@((int?)context.CellValue ?? context.Item.ProtocolEDCFieldId)"
                                DefaultItemText="Select"></SelectList>
                </EditTemplate>
            </DataGridColumn>
            <DataGridCommandColumn NewCommandAllowed="false" EditCommandAllowed="true" DeleteCommandAllowed="true">
                <SaveCommandTemplate>
                    <Button><Icon Name="IconName.Save" Clicked="@context.Clicked" /></Button>
                </SaveCommandTemplate>
                <EditCommandTemplate>
                    <Button><Icon Name="IconName.Edit" Clicked="@context.Clicked" /></Button>
                </EditCommandTemplate>
                <DeleteCommandTemplate>
                    <Button><Icon Name="IconName.Delete" Clicked="@context.Clicked" /></Button>
                </DeleteCommandTemplate>
                <CancelCommandTemplate>
                    <Button><Icon Name="IconName.Times" Clicked="@context.Clicked" /></Button>
                </CancelCommandTemplate>
            </DataGridCommandColumn>
            <DataGridColumn Field="@nameof(ProtocolFieldMapping.ThorDictionaryId)" Caption="Dicitionary Mapping">
                <DisplayTemplate>
                   @if(context.ThorField != null && context.ThorField.ThorDictionaryId != null && context.ThorField.ThorDictionaryId != 0)
				   {
                        <Button Color="Color.Primary" Clicked="@((item) => EditDictionaryMapping(context, protocolEDCFormList.First(x => x.ProtocolEDCFormId == context.ProtocolEDCFormId).EDCFormIdentifier))">Edit</Button>
				   }
                   else{
                       <Text>N/A</Text>
                   }
                </DisplayTemplate>
            </DataGridColumn>
            <DataGridColumn Field="@nameof(ProtocolFieldMapping.ThorFieldId)" Caption="Multi Form Field">
                <DisplayTemplate>
                    @if(context.ThorField != null && context.ThorField.IsMultiForm)
					{
						<Button Color="Color.Primary" Clicked="@(() => AddMultiFormField(context))">Add Form</Button>
					}
					else{
						<Text>N/A</Text>
					}
                </DisplayTemplate>

            </DataGridColumn>
        </DataGridColumns>
        <ButtonRowTemplate>
            <Button Color="Color.Primary" Clicked="@context.NewCommand.Clicked">Add</Button>
        </ButtonRowTemplate>
        <EmptyTemplate>
            <div class="box">
                No multi-form field mappings found.
            </div>
        </EmptyTemplate>
    </DataGrid>
}
else{
    foreach(var form in multiFormList){
        <Row>
            <Column><b>Form @FormIndex(): </b><SelectList TItem="ProtocolEDCForm" Data="@protocolEDCFormList" TValue="int" ValueField="@((item) => item.ProtocolEDCFormId)" TextField="@((item) => item.EDCFormName)" SelectedValue="@(form.ProtocolEDCFormId ?? 0)" SelectedValueChanged="@(v=> { form.ProtocolEDCFormId = v; UpdateFields(v, form.ProtocolFormMappingId); this.protocolFormMappingService.SaveProtocolFormMapping(form);})" DefaultItemText="Select a Form" DefaultItemValue="0"></SelectList></Column>
            <Column><Switch TValue="bool" Checked="@form.IsPrimaryForm" CheckedChanged="@((v) => {UpdatePrimaryForm(v, form);})">Primary Form</Switch></Column>
        </Row>
		<DataGrid @ref=multiFormRefs[form.ProtocolFormMappingId]
			  TItem="ProtocolFieldMapping"
			  Class="admindatagrid"
			  Data="@multiFormMappings[form.ProtocolFormMappingId]"
			  Editable
			  Responsive
			  Striped
			  ShowPager
			  ShowPageSizes
			  MaxPaginationLinks="5"
			  PagerPosition="DataGridPagerPosition.Bottom"
			  PagerOptions="new(){ButtonSize=Size.Default,
								PaginationPosition=PagerElementPosition.Default,
								TotalItemsPosition=PagerElementPosition.End,
								}"
			  FixedHeader
			  EditMode="DataGridEditMode.Inline"
			  RowUpdated="@Save"
			  RowInserted="@Save"
			  RowRemoved="@Delete"
			  RowRemoving="@ConfirmDelete">
		<DataGridColumns>
			<DataGridColumn Field="@nameof(ProtocolFieldMapping.ThorFieldId)" Width="25%" Caption="Select OARS Field" Editable="true" SortDirection="SortDirection.Ascending" Sortable>
				<DisplayTemplate>
					<Text>@GetThorFieldLabel(context)</Text>
				</DisplayTemplate>
				<EditTemplate>
					<Text>@GetThorFieldLabel(context.Item)</Text>
				  </EditTemplate>
			</DataGridColumn>
                <DataGridColumn Field="@nameof(ProtocolFieldMapping.ProtocolEDCFieldId)" Width="25%" Caption="Select EDC Field" Editable="true" Sortable>
                    <DisplayTemplate>
                        @{
                            if (context.ProtocolEDCFieldId != null && context.ProtocolEDCFieldId != 0)
                            {
                                var currentField = edcFieldsByForm[form.ProtocolFormMappingId].First(x => x.ProtocolEDCFieldId == context.ProtocolEDCFieldId);
                                <Text>@(currentField.EDCFieldIdentifier + " - " + currentField.EDCFieldName)</Text>
                            }
                            else if (context.ProtocolEDCField != null && context.ProtocolEDCField.ProtocolEDCFieldId != 0)
                            {
                                <Text>@context.ProtocolEDCField.EDCFieldIdentifier</Text>
                            }
                            else
                            {
                                <Text>Not Mapped</Text>
                            }
                        }
                    </DisplayTemplate>
                    <EditTemplate>
                        <SelectList TItem="ProtocolEDCField" TValue="int" Data="@edcFieldsByForm[form.ProtocolFormMappingId]" TextField="@((item)=>item.EDCFieldIdentifier + " - " + item.EDCFieldName)"
                                    ValueField="@((item) => item.ProtocolEDCFieldId)"
                                    SelectedValueChanged="@( v =>{context.CellValue = v;})"
                                    SelectedValue="@((int?)context.CellValue ?? context.Item.ProtocolEDCFieldId)"
                                    DefaultItemText="Select"></SelectList>
                    </EditTemplate>
                </DataGridColumn>
                <DataGridCommandColumn NewCommandAllowed="false" EditCommandAllowed="true" DeleteCommandAllowed="true">
                    <SaveCommandTemplate>
                        <Button><Icon Name="IconName.Save" Clicked="@context.Clicked" /></Button>
                    </SaveCommandTemplate>
                    <EditCommandTemplate>
                        <Button><Icon Name="IconName.Edit" Clicked="@context.Clicked" /></Button>
                    </EditCommandTemplate>
                    <DeleteCommandTemplate>
                        <Button><Icon Name="IconName.Delete" Clicked="@context.Clicked" /></Button>
                    </DeleteCommandTemplate>
                    <CancelCommandTemplate>
                        <Button><Icon Name="IconName.Times" Clicked="@context.Clicked" /></Button>
                    </CancelCommandTemplate>
                </DataGridCommandColumn>
                <DataGridColumn Field="@nameof(ProtocolFieldMapping.ThorDictionaryId)" Caption="Dicitionary Mapping">
                    <DisplayTemplate>
                        @if (context.ThorField != null && context.ThorField.ThorDictionaryId != null && context.ThorField.ThorDictionaryId != 0)
                        {
                            <Button Color="Color.Primary" Clicked="@((item) => EditDictionaryMapping(context, protocolEDCFormList.First(x => x.ProtocolEDCFormId == context.ProtocolEDCFormId).EDCFormIdentifier))">Edit</Button>
                        }
                        else
                        {
                            <Text>N/A</Text>
                        }
                    </DisplayTemplate>
                </DataGridColumn>
        </DataGridColumns>
        </DataGrid>
    }
    <Button Color="Color.Primary" Clicked="AddForm">Add Form</Button>
}

@code {
    [Inject] IProtocolEDCFormService protocolEDCFormService { get; set; } = null!;
    [Inject] IProtocolEDCFieldService protocolEDCFieldService { get; set; } = null!;
    [Inject] IProtocolDataCategoryService protocolCategoryService { get; set; } = null!;
    [Inject] IThorCategoryService thorCategoryService { get; set; } = null!;
    [Inject] IThorFieldService thorFieldService { get; set; } = null!;
    [Inject] IProtocolFieldMappingService protocolFieldMappingService { get; set; } = null!;
    [Inject] IProtocolFormMappingService protocolFormMappingService { get; set; } = null!;
    [Inject] private NavigationManager navigation { get; set; } = null!;
    [Inject] INotificationService notificationService { get; set; }
    [Inject] private IMessageService messageService { get; set; } = null!;

    [Parameter] public int protocolCategoryId { get; set; }
    [SupplyParameterFromQuery][Parameter] public string protocol { get; set; }
    [SupplyParameterFromQuery][Parameter] public int protocolMappingId { get; set; }

    private DataGrid<ProtocolFieldMapping> dataGridRef;
    private IList<ProtocolFieldMapping> protocolFieldMappingList;
    private IList<ProtocolEDCForm> protocolEDCFormList;
    private IList<ProtocolEDCField> protocolEDCFieldList;
    private ProtocolDataCategory protocolCategory;
    private IList<ThorField> thorFieldList;
    private ThorCategory currCategory;
    private bool isMultiForm;
    private bool isComplete;
    private int formIndex = 0;

    private IList<ProtocolFormMapping> multiFormList;
    private Dictionary<int, DataGrid<ProtocolFieldMapping>> multiFormRefs = new Dictionary<int, DataGrid<ProtocolFieldMapping>>();
    private Dictionary<int, IList<ProtocolFieldMapping>> multiFormMappings = new Dictionary<int, IList<ProtocolFieldMapping>>();
    private Dictionary<int, IList<ProtocolEDCField>> edcFieldsByForm = new Dictionary<int, IList<ProtocolEDCField>>();

    protected override async Task OnInitializedAsync()
    { 
        this.protocolCategory = await protocolCategoryService.GetCategory(protocolCategoryId);
        this.isComplete = protocolCategory.ProtocolCategoryStatusId == 3;
        this.currCategory = await thorCategoryService.GetCategory(protocolCategory.THORDataCategoryId);
        this.protocolFieldMappingList = await protocolFieldMappingService.GetProtocolFieldMappingsForCategory(currCategory.ThorDataCategoryId);
        this.protocolEDCFormList = await protocolEDCFormService.GetProtocolEDCForms();
        this.thorFieldList = await thorFieldService.GetFields(currCategory.ThorDataCategoryId);

        this.protocolFieldMappingList = AddMissingFields(this.protocolFieldMappingList, 0);

        this.currCategory = await thorCategoryService.GetCategory(currCategory.ThorDataCategoryId);

        this.multiFormList = await protocolFormMappingService.GetProtocolFormMappingsForCategory(protocolCategoryId);
        foreach(var form in multiFormList)
        {
            multiFormRefs.Add(form.ProtocolFormMappingId, new DataGrid<ProtocolFieldMapping>());
            List<ProtocolFieldMapping> formMappings = protocolFieldMappingList.Where(x => x.ProtocolEDCFormId == form.ProtocolEDCFormId).ToList();

            formMappings = AddMissingFields(formMappings, form.ProtocolEDCFormId).ToList();
            multiFormMappings.Add(form.ProtocolFormMappingId, formMappings);
            if(form.ProtocolEDCFormId != null && form.ProtocolEDCFormId != 0)
            {
                UpdateFields((int)form.ProtocolEDCFormId, form.ProtocolFormMappingId);
            }
        }
    }

    public async void GetFields(int formId)
    {
        this.protocolEDCFieldList = await protocolEDCFieldService.GetFieldsByFormIds(new List<int> { formId });
    }

    public async void UpdateFields(int formId, int mappingId)
    {
        this.edcFieldsByForm[mappingId] = await protocolEDCFieldService.GetFieldsByFormIds(new List<int> { formId });
    }

    public IList<ProtocolFieldMapping> AddMissingFields(IList<ProtocolFieldMapping> mappings, int? formId)
    {
        if(formId == null)
        {
            formId = 0;
        }
        var fieldMappingIds = mappings.Select(x => x.ThorFieldId).ToList();
        foreach (var field in thorFieldList)
        {
            if (!fieldMappingIds.Contains(field.ThorFieldId))
            {
                mappings.Add(new ProtocolFieldMapping { ThorFieldId = field.ThorFieldId, ThorField = field, ProtocolEDCFieldId = 0, ProtocolEDCFormId = (int)formId });
            }
        }

        return mappings;
    }

    public async void Save(SavedRowItem<ProtocolFieldMapping, Dictionary<string, object>> savedRowItem)
    {
        var toSave = savedRowItem.Item;

        bool saved = await protocolFieldMappingService.SaveProtocolFieldMapping(toSave);

        if (saved)
        {
            await notificationService.Success("Mapping successfully saved");
            return;
        }
        else
        {
            await notificationService.Error("Error saving mapping");
            return;
        }
    }

    private string GetPlaceholder(ProtocolFieldMapping item)
    {
        if (item.ProtocolEDCFormId == 0 && item.ProtocolEDCField == null)
        {
            return "Start typing to select an EDC form";
        }
        else if (item.ProtocolEDCFormId != 0 && item.ProtocolEDCField == null)
        {
            return protocolEDCFormList.First(x => x.ProtocolEDCFormId == item.ProtocolEDCFormId).EDCFormIdentifier;
        }
        return item.ProtocolEDCField.ProtocolEDCForm.EDCFormIdentifier;
    }

    public string GetThorFieldLabel(ProtocolFieldMapping item)
    {
        if (item.ThorFieldId != null && item.ThorFieldId != "")
        {
            return thorFieldList.First(x => x.ThorFieldId == item.ThorFieldId).FieldLabel;
        }
        else
        {
            return item.ThorField.FieldLabel;
        }
    }

    public async Task<CancellableRowChange<ProtocolFieldMapping>> ConfirmDelete(CancellableRowChange<ProtocolFieldMapping> item)
    {
        if (!await messageService.Confirm("Are you sure you want to delete this mapping?", "Confirmation"))
        {
            item.Cancel = true;
        }

        return item;
    }


    public async void Delete(ProtocolFieldMapping item)
    {
        if(item.ProtocolFieldMappingId == 0)
        {
            protocolFieldMappingList.Remove(item);
            return;
        }

        bool deleted = await protocolFieldMappingService.DeleteProtocolFieldMapping(item);
        if (deleted)
        {
            await notificationService.Success("Mapping successfully deleted");
            return;
        }
        else
        {
            await notificationService.Error("Error deleting mapping");
            return;
        }
    }

    public async void UpdatePrimaryForm(bool isPrimaryForm, ProtocolFormMapping form)
    {
        form.IsPrimaryForm = isPrimaryForm;
        bool saved = await protocolFormMappingService.SaveProtocolFormMapping(form);
        if (saved)
        {
            foreach(var otherForm in this.multiFormList)
            {
                if(otherForm.ProtocolFormMappingId != form.ProtocolFormMappingId)
                {
                    otherForm.IsPrimaryForm = false;
                    await this.protocolFormMappingService.SaveProtocolFormMapping(otherForm);
                }
            }
            await notificationService.Success("Primary form updated");
            return;
        }
        else
        {
            await notificationService.Error("Error updating primary form");
            return;
        }
    }

    public async void EditDictionaryMapping(ProtocolFieldMapping item, string formLabel)
    {
        navigation.NavigateTo($"/admin/dmu/dictionary-list-map/{item.ProtocolFieldMappingId}?protocolMappingId={this.protocolMappingId}&protocolTitle={this.protocol}&categoryName={currCategory.CategoryName}&formLabel={formLabel}", true);
    }

    public async void AddMultiFormField(ProtocolFieldMapping item)
    {
        this.protocolFieldMappingList.Add(new ProtocolFieldMapping { ThorFieldId = item.ThorFieldId, ThorField = item.ThorField, ProtocolEDCFieldId = 0, ProtocolEDCFormId = 0 });
    }

    public async void AddForm()
    {
        ProtocolFormMapping newForm = new ProtocolFormMapping { ProtocolEDCFormId = null, ProtocolCategoryId = protocolCategoryId };
        this.protocolFormMappingService.SaveProtocolFormMapping(newForm);
        this.multiFormRefs.Add(newForm.ProtocolFormMappingId, new DataGrid<ProtocolFieldMapping>());
        this.multiFormMappings.Add(newForm.ProtocolFormMappingId, new List<ProtocolFieldMapping>());

        foreach(var thorField in this.thorFieldList){
            this.multiFormMappings[newForm.ProtocolFormMappingId].Add(new ProtocolFieldMapping { ThorFieldId = thorField.ThorFieldId, ThorField = thorField, ProtocolEDCFieldId = 0, ProtocolEDCFormId = 0 });
        }

        this.edcFieldsByForm.Add(newForm.ProtocolFormMappingId, new List<ProtocolEDCField>());
    }

    public async void CompleteMapping()
    {
        if(this.isComplete){
            foreach(var mapping in protocolFieldMappingList){
                if(mapping.ProtocolEDCFormId == 0 || mapping.ProtocolEDCFieldId == 0){
                    await notificationService.Error("Please complete all mappings before marking as complete");
                    isComplete = false;
                    return;
                }
            }
            this.protocolCategory.ProtocolCategoryStatusId = 3; // set to complete
            bool saved = await protocolCategoryService.SaveCategory(this.protocolCategory, this.protocolMappingId);
            if (saved)
            {
                await notificationService.Success("Category successfully marked as complete");
                return;
            }
            else
            {
                await notificationService.Error("Error marking category as complete");
                return;
            }
        }
    }

    public int FormIndex()
    {
        this.formIndex += 1;
        return this.formIndex;
    }
}